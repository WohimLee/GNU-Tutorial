
## 虚拟内存布局

当可执行程序被操作系统加载运行时，会被分配到一个 虚拟地址空间。在 `32 位`系统中，虚拟空间通常最大为 `4GB`；在 `64 位` 系统中则远大于此。虚拟空间通常被划分为以下区域：

#### 1 主要分区
- **代码段（Text Segment / Code Segment）**
存放程序的机器指令。一般为只读，避免运行时修改代码
例如：main 函数和 printf 函数的指令都在这里

- **已初始化数据段（.data）**
存放已赋初值的全局变量和静态变量。
    ```cpp
    int g = 10; // 在 .data 段
    ```

- **未初始化数据段（.bss）**
存放未赋值的全局变量和静态变量，运行时由系统初始化为 0。
    ```cpp
    static int counter; // 在 .bss 段，值默认为 0
    ```

- **堆（Heap）**
存放动态分配的内存（malloc/new）。地址由低向高增长，需要程序员手动释放
    ```cpp
    int *p = malloc(sizeof(int) * 100); // 100 个整数在堆上
    ```

- **栈（Stack）**
存放局部变量、函数参数和返回地址。地址由高向低增长，由编译器自动管理。
    ```cpp
    void foo() {
        int a = 5; // 在栈上
    }
    ```

    栈同时记录函数调用关系（调用栈），保证函数执行完能正确返回。

- **只读数据段（.rodata）**
存放常量字符串和常量数据。
    ```cpp
    char *msg = "Hello!"; // "Hello!" 在 .rodata
    ```

#### 2 典型虚拟内存布局（简化）
```
高地址
│
│   +--------------------+
│   |      栈 (Stack)    |  ← 局部变量、调用记录
│   |   向下增长 ↓       |
│   +--------------------+
│   |        空闲        |
│   +--------------------+
│   |      堆 (Heap)     |  ← 动态分配内存
│   |   向上增长 ↑       |
│   +--------------------+
│   |   未初始化数据 (.bss) |
│   +--------------------+
│   |   已初始化数据 (.data)|
│   +--------------------+
│   |   只读数据 (.rodata) |
│   +--------------------+
│   |   代码段 (Text)    |  ← 程序机器指令
│   +--------------------+
│
低地址
```

#### 3 Hello World 程序内存分布示例
- `代码段`：main、printf 的机器指令
- `.data 段`：全局变量 g
- `.bss 段`：静态变量 bssVal
- `堆`：若使用 malloc 分配的动态内存
- `栈`：局部变量 local，函数调用信息
- `.rodata`：字符串常量 "Hello!"

```cpp
#include <stdio.h>

int g = 10;        // 在 .data 段
static int bssVal; // 在 .bss 段，值默认为 0

int main() {
    int local = 5;          // 在 栈 上
    char *msg = "Hello!";   // "Hello!" 在 .rodata
    printf("%s\n", msg);    // 调用库函数，最终系统调用 write
    return 0;
}
```

